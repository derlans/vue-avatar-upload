var Ve=Object.defineProperty,ze=Object.defineProperties;var be=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var ke=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable;var H=(e,p,y)=>p in e?Ve(e,p,{enumerable:!0,configurable:!0,writable:!0,value:y}):e[p]=y,Y=(e,p)=>{for(var y in p||(p={}))ke.call(p,y)&&H(e,y,p[y]);if(W)for(var y of W(p))Ie.call(p,y)&&H(e,y,p[y]);return e},Z=(e,p)=>ze(e,be(p));(function(e,p){typeof exports=="object"&&typeof module!="undefined"?module.exports=p(require("vue")):typeof define=="function"&&define.amd?define(["vue"],p):(e=typeof globalThis!="undefined"?globalThis:e||self,e["vue-avatar-upload"]=p(e.Vue))})(this,function(e){"use strict";function p(n,t){const a=t.zoom||1,s=n.left-t.left>0?n.left-t.left:0,o=n.top-t.top>0?n.top-t.top:0,r=n.width,i=n.height;return{sx:s/a,sy:o/a,sw:r/a,sh:i/a}}function y(){const n=document.createElement("canvas"),t=n.getContext("2d");return function(s,o,r="png"){const{sx:i,sy:u,sw:c,sh:w}=o;return new Promise((m,f)=>{const v=new Image;v.crossOrigin="",v.src=s,v.onload=()=>{n.height=w,n.width=c,t.drawImage(v,i,u,c,w,0,0,c,w),n.toBlob(E=>{E&&m(E),f(new Error("canvas to blob error")),t.restore()},r)},v.onerror=E=>{f(E)}})}}function Q(n){return Math.sqrt(n.reduce((t,a)=>t+a**2,0))}function j(n,t){const a=Q(t);let s=0;return n.forEach((o,r)=>{s+=o*t[r]}),s/a}function G(n,t,a="POST",s){return new Promise((o,r)=>{const i=new XMLHttpRequest,u=s.headers||{};Object.keys(u).forEach(c=>{i.setRequestHeader(c,u[c])}),i.withCredentials=!!s.withCredentials,i.open(a,t),i.onload=()=>{i.status===200?o(i.response):r(new Error(i.statusText))},i.onerror=()=>{r(new Error("Network Error"))},i.send(n)})}function J(){return!!navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)}function B(n,t,a,s){e.watch(n,()=>{n.value&&n.value.addEventListener(t,a,s)},{immediate:!0})}function L(n,t={stop:!1,preventDefault:!1}){var C;const a=(C=t.draggingBox)!=null?C:e.ref(document),{stop:s,preventDefault:o,range:r={}}=t,i=J(),u=e.ref(0),c=e.ref(0),w=e.ref(!1),m={x:0,y:0};function f(h){s&&h.stopPropagation(),o&&h.preventDefault()}const v=h=>{h.preventDefault()};function E(h){if(i){const S=h;m.x=S.touches[0].clientX,m.y=S.touches[0].clientY}else{const S=h;m.x=S.x,m.y=S.y}}const x=h=>{f(h),w.value=!0,E(h),i&&document.addEventListener("touchmove",v,{passive:!1})},_=h=>{var S,$,D,b;if(f(h),!!w.value){if(i){const V=h;u.value+=V.touches[0].clientX-m.x,c.value+=V.touches[0].clientY-m.y}else{const V=h;u.value+=V.x-m.x,c.value+=V.y-m.y}r&&(((S=r.x)==null?void 0:S.min)!==void 0&&u.value<r.x.min&&(u.value=r.x.min),(($=r.x)==null?void 0:$.max)!==void 0&&u.value>r.x.max&&(u.value=r.x.max),((D=r.y)==null?void 0:D.min)!==void 0&&c.value<r.y.min&&(c.value=r.y.min),((b=r.y)==null?void 0:b.max)!==void 0&&c.value>r.y.max&&(c.value=r.y.max)),E(h)}},N=h=>{f(h),i&&document.removeEventListener("touchmove",v),w.value=!1},I=e.computed(()=>({top:`${c.value}px`,left:`${u.value}px`}));return i?(B(n,"touchstart",x),B(a,"touchmove",_),B(a,"touchend",N)):(B(n,"mousedown",x),B(a,"mousemove",_),B(a,"mouseup",N)),{x:u,y:c,isDraging:w,style:I}}function K(n,t){const a=e.ref(0);function s(o){a.value+=o.deltaY>0?1:-1,t(o.deltaY>0?1:-1),o.preventDefault()}return B(n,"wheel",s),{wheel:a}}const X=.02;function ee(n,t){K(n,s);const a=e.ref(1);function s(m){a.value+=m>0?X:-X}const o=e.ref(0);function r(){o.value=(o.value+90)%360}const{style:i,x:u,y:c}=L(n,{stop:!0,preventDefault:!1}),w=e.computed(()=>Z(Y({},i.value),{width:`${t.width*a.value}px`,height:`${t.height*a.value}px`,transform:`rotate(${o.value}deg)`}));return{bgImgZoom:a,editPositionStyle:i,baImgX:u,baImgY:c,bgImgStyle:w,imgRotate:o,updateRotate:r}}function te(n,t,a,s){const o=e.ref(n),{x:r,y:i}=L(a,{stop:!0,preventDefault:!1}),u={x:{min:0,max:s.width-o.value},y:{min:0,max:s.height-o.value}};function c(){u.x.max=s.width-o.value,u.y.max=s.height-o.value}const{style:w,x:m,y:f}=L(t,{stop:!0,preventDefault:!1,range:u}),v=e.computed(()=>Y({width:`${o.value}px`,height:`${o.value}px`},w.value));function E(){o.value+m.value>s.width&&(o.value=s.width-m.value),o.value+f.value>s.height&&(o.value=s.height-f.value)}return e.watch([r,i],(x,_)=>{const N=x[0]-_[0],I=x[1]-_[1],C=j([N,I],[1,1]);o.value=o.value+C,o.value=o.value<=0?0:o.value,E(),c()}),{resizeX:r,resizeY:i,selectBoxSize:o,selectBoxStyle:v,selectPositionStyle:w,selectX:m,selectY:f}}var q={"zh-CN":{title:"\u7F16\u8F91\u5934\u50CF",changeAvatar:"\u66F4\u6362\u5934\u50CF",rotate:"\u65CB\u8F6C90\u5EA6",preview:"\u9884\u89C8"},"zh-TW":{title:"\u7DE8\u8F2F\u982D\u50CF",changeAvatar:"\u66F4\u63DB\u982D\u50CF",rotate:"\u65CB\u8F4990\u5EA6",preview:"\u9810\u89BD"},en:{title:"Edit Avatar",changeAvatar:"Change Avatar",rotate:"Rotate 90\xB0",preview:"Preview"}},De="",oe=(n,t)=>{const a=n.__vccOpts||n;for(const[s,o]of t)a[s]=o;return a};const R=n=>(e.pushScopeId("data-v-072b93c8"),n=n(),e.popScopeId(),n),ne={class:"avatar-upload-header"},ae={key:0,class:"avatar-upload-title"},le={key:0,t:"1649489376154",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"2215",width:"16",height:"16"},re=[R(()=>e.createElementVNode("path",{d:"M184.64768 836.34176c3.9936 3.9936 9.23648 5.98016 14.47936 5.98016 5.24288 0 10.48576-2.00704 14.49984-6.00064l292.70016-293.04832 292.70016 293.04832c3.9936 4.01408 9.23648 6.00064 14.49984 6.00064 5.24288 0 10.48576-2.00704 14.47936-5.98016 8.00768-7.9872 8.00768-20.95104 0.02048-28.95872L535.61344 514.64192 828.0064 221.92128c7.9872-8.00768 7.9872-20.97152-0.02048-28.95872-8.02816-8.00768-20.97152-8.00768-28.95872 0.02048L506.30656 486.03136 213.6064 192.98304c-8.00768-8.00768-20.97152-8.00768-28.95872-0.02048-8.00768 7.9872-8.00768 20.95104-0.02048 28.95872l292.37248 292.72064L184.6272 807.38304C176.64 815.37024 176.64 828.35456 184.64768 836.34176z",fill:"","p-id":"2216"},null,-1))],se={class:"avatar-upload-main"},ie=R(()=>e.createElementVNode("div",{class:"edit-fade"},null,-1)),ce={class:"edit-selcet-img-box"},de=["src"],ue=R(()=>e.createElementVNode("span",{class:"edit-selcet-border border-3-white"},null,-1)),fe=["src"],he={class:"avatar-upload-operation"},pe=R(()=>e.createElementVNode("svg",{t:"1649489582570",class:"icon-rotate",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"3047",width:"16",height:"16"},[e.createElementVNode("path",{d:"M503.466667 285.866667L405.333333 226.133333c-8.533333-8.533333-12.8-21.333333-8.533333-29.866666 8.533333-8.533333 21.333333-12.8 29.866667-8.533334l145.066666 89.6c8.533333 4.266667 12.8 17.066667 8.533334 29.866667l-89.6 145.066667c-4.266667 8.533333-17.066667 12.8-29.866667 8.533333-8.533333-4.266667-12.8-17.066667-8.533333-29.866667l64-102.4c-123.733333 4.266667-226.133333 106.666667-226.133334 234.666667s106.666667 234.666667 234.666667 234.666667c85.333333 0 162.133333-46.933333 204.8-119.466667 4.266667-8.533333 17.066667-12.8 29.866667-8.533333 8.533333 4.266667 12.8 17.066667 8.533333 29.866666-51.2 85.333333-140.8 140.8-238.933333 140.8-153.6 0-277.333333-123.733333-277.333334-277.333333 0-145.066667 110.933333-264.533333 251.733334-277.333333z","p-id":"3048"})],-1)),me={key:0,class:"avatar-upload-preview"},ge=["src"],we=["src"],ve={class:"avatar-upload-actions"},xe={class:"avatar-upload-form"},ye=["name","accept"];var A=oe(e.defineComponent({props:{avatar:null,url:null,field:{default:"avatar"},format:{default:"png"},headers:null,data:null,width:{default:300},height:{default:300},selectSize:{default:300},withCredentials:{type:Boolean,default:!1},method:{default:"POST"},accept:{default:"image/*"},rotate:{type:Boolean,default:!0},fixed:{type:Boolean,default:!0},showPreview:{type:Boolean,default:!0},previewSize:{default:100},i18:null,lang:{default:"zh-CN"},onCustomRequest:null,onBefoureUpload:null,onSuccess:null,onError:null,onClose:null},setup(n){const t=n,a=t.i18||q[t.lang]||q["zh-CN"],s=e.useSlots(),o=e.ref(t.avatar||""),{width:r,height:i,selectSize:u,previewSize:c}=t,w=u<Math.min(t.width,t.height)?u:Math.min(t.width,t.height),m={width:`${r}px`,height:`${i}px`},f=e.reactive({width:r,height:i}),v=e.ref(null);e.watch(v,()=>{var d;(d=v.value)!=null&&d.width&&S()},{immediate:!0});const E=e.ref(null),{bgImgZoom:x,baImgX:_,baImgY:N,bgImgStyle:I,imgRotate:C,updateRotate:h}=ee(E,f);function S(){e.nextTick(()=>{const d=v.value;d.onload=()=>{const l=d.naturalWidth,g=d.naturalHeight;l/g>r/i?(x.value=i/g,f.height=g,f.width=l):(x.value=r/l,f.height=g,f.width=l),_.value=0,N.value=0}})}const $=e.ref(null),D=e.ref(null),{selectBoxSize:b,selectBoxStyle:V,selectX:P,selectY:O}=te(w,$,D,{width:r,height:i}),Se=e.computed(()=>({width:`${f.width*x.value}px`,height:`${f.height*x.value}px`,left:`${_.value-P.value}px`,top:`${N.value-O.value}px`,transform:`rotate(${C.value}deg)`})),T=e.computed(()=>({width:`${c}px`,height:`${c}px`})),F=e.computed(()=>{const d=c/b.value;return{width:`${f.width*d*x.value}px`,height:`${f.height*d*x.value}px`,left:`${(_.value-P.value)*d}px`,top:`${(N.value-O.value)*d}px`,transform:`rotate(${C.value}deg)`}}),U=e.ref(null);function _e(d){const l=d.target,g=new FileReader;g.onload=k=>{const z=k.target.result;z&&(o.value=z,S())},g.readAsDataURL(l.files[0])}async function Ne(){const d=new FormData,l=await Ce(),g=t.format;d.append(t.field,l);const k=new File([l],`avatar.${g}`,{type:`image/${g}`});if(t.onCustomRequest){await t.onCustomRequest(k);return}t.onBefoureUpload&&!await t.onBefoureUpload(k)||G(d,t.url,t.method,{headers:t.headers,data:t.data,withCredentials:t.withCredentials}).then(z=>{var M;(M=t.onSuccess)==null||M.call(t,k,z)}).catch(z=>{var M;(M=t==null?void 0:t.onError)==null||M.call(t,k,z)})}const Be=y();function Ce(){const d=p({left:P.value,top:O.value,width:b.value,height:b.value},{left:_.value,top:N.value,width:f.width,height:f.height,zoom:x.value});return Be(o.value,d,t.format)}return(d,l)=>(e.openBlock(),e.createElementBlock("div",{class:e.normalizeClass({"avatar-upload-root":!0,"avatar-upload-root-fixed":t.fixed})},[e.createElementVNode("div",{class:e.normalizeClass({"avatar-upload-fade":t.fixed})},null,2),e.createElementVNode("div",{class:e.normalizeClass({"avatar-upload":!0,"avatar-upload-fixed":t.fixed})},[e.createElementVNode("div",ne,[e.unref(s).title?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",ae,e.toDisplayString(e.unref(a).title),1)),e.renderSlot(d.$slots,"title",{},void 0,!0),e.createElementVNode("div",{class:"avatar-upload-close",onClick:l[0]||(l[0]=(...g)=>t.onClose&&t.onClose(...g))},[e.renderSlot(d.$slots,"closeIcon",{},void 0,!0),e.unref(s).closeIcon?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("svg",le,re))])]),e.createElementVNode("div",se,[e.createElementVNode("div",null,[e.createElementVNode("div",{ref_key:"editBox",ref:E,class:"avatar-upload-edit",style:m},[ie,e.createElementVNode("div",{ref_key:"select",ref:$,class:"edit-select",style:e.normalizeStyle(e.unref(V))},[e.createElementVNode("span",ce,[e.createElementVNode("img",{src:o.value,alt:"",style:e.normalizeStyle(e.unref(Se)),class:"edit-select-img",onDragstart:l[1]||(l[1]=e.withModifiers(()=>{},["prevent"])),onSelect:l[2]||(l[2]=e.withModifiers(()=>{},["prevent"]))},null,44,de)]),ue,e.createElementVNode("span",{ref_key:"resize",ref:D,class:"select-zoom-point"},null,512)],4),e.createElementVNode("img",{ref_key:"bgAvatar",ref:v,src:o.value,alt:"",style:e.normalizeStyle(e.unref(I)),class:"edit-bg",onDragstart:l[3]||(l[3]=e.withModifiers(()=>{},["prevent"])),onSelect:l[4]||(l[4]=e.withModifiers(()=>{},["prevent"]))},null,44,fe)],512),e.createElementVNode("div",he,[e.createElementVNode("span",{style:{cursor:"pointer"},onClick:l[5]||(l[5]=g=>U.value.click())},e.toDisplayString(e.unref(a).changeAvatar),1),e.createElementVNode("span",{style:{cursor:"pointer"},class:"upload-operation-close",onClick:l[6]||(l[6]=(...g)=>e.unref(h)&&e.unref(h)(...g))},[t.rotate?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[pe,e.createElementVNode("span",null,e.toDisplayString(e.unref(a).rotate),1)],64)):e.createCommentVNode("",!0)])])]),t.showPreview?(e.openBlock(),e.createElementBlock("div",me,[e.createElementVNode("span",null,e.toDisplayString(e.unref(a).preview),1),e.createElementVNode("div",{class:"preview-radius border-3-white",style:e.normalizeStyle(e.unref(T))},[e.createElementVNode("img",{src:o.value,alt:"",style:e.normalizeStyle(e.unref(F)),onDragstart:l[7]||(l[7]=e.withModifiers(()=>{},["prevent"])),onSelect:l[8]||(l[8]=e.withModifiers(()=>{},["prevent"]))},null,44,ge)],4),e.createElementVNode("div",{class:"preview-square border-3-white",style:e.normalizeStyle(e.unref(T))},[e.createElementVNode("img",{src:o.value,alt:"",style:e.normalizeStyle(e.unref(F)),onDragstart:l[9]||(l[9]=e.withModifiers(()=>{},["prevent"])),onSelect:l[10]||(l[10]=e.withModifiers(()=>{},["prevent"]))},null,44,we)],4)])):e.createCommentVNode("",!0)]),e.createElementVNode("div",ve,[e.createElementVNode("div",{onClick:l[11]||(l[11]=(...g)=>t.onClose&&t.onClose(...g))},[e.renderSlot(d.$slots,"close",{},void 0,!0)]),e.createElementVNode("div",{onClick:Ne},[e.renderSlot(d.$slots,"upload",{},void 0,!0)])]),e.withDirectives(e.createElementVNode("div",xe,[e.createElementVNode("input",{ref_key:"file",ref:U,type:"file",name:t.field,accept:t.accept,onInput:_e},null,40,ye)],512),[[e.vShow,!1]])],2)],2))}}),[["__scopeId","data-v-072b93c8"]]);const Ee="VueAvatarUpload";return A.install=function(n){n.component(Ee,A)},A});
